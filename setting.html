<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹¤ì‹œê°„ ìë§‰ ì œì–´íŒ</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #111;
      color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-top: 0;
    }
    .panel {
      background: #1d1d1d;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }
    label {
      min-width: 120px;
      font-weight: 600;
    }
    input[type="range"] {
      width: 200px;
    }
    input[type="color"], select, input[type="file"] {
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 6px 8px;
    }
    button {
      background: #0d6efd;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
    button.secondary {
      background: #444;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      font-size: 14px;
      color: #7cf08c;
    }
    .preview {
      background: #000;
      padding: 12px;
      border-radius: 8px;
      min-height: 80px;
      margin-top: 8px;
    }
    .logo-preview {
      max-height: 80px;
      max-width: 120px;
      object-fit: contain;
      background: #000;
      padding: 6px;
      border: 1px dashed #444;
      border-radius: 8px;
    }
    small {
      color: #999;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      background: #181818;
      color: #f4f4f4;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      line-height: 1.4;
      resize: vertical;
    }
  </style>
</head>
<body>
  <!-- DeepL API ì „í™˜ ê°€ì´ë“œ:
       ì•„ë˜ translateText í•¨ìˆ˜ì˜ MYMEMORY_ENDPOINT ëŒ€ì‹  DeepL API í˜¸ì¶œë¡œ êµì²´í•˜ê³ ,
       const DEEPL_API_KEY = "ì—¬ê¸°ì—_í‚¤"; ì£¼ì… í›„ í—¤ë”/íŒŒë¼ë¯¸í„°ë¥¼ ë§ì¶°ì£¼ì„¸ìš”. -->
  <h1>ì‹¤ì‹œê°„ ìë§‰ ì œì–´íŒ</h1>

  <div class="panel">
    <div class="row">
      <label for="inputLang">ì…ë ¥ ì–¸ì–´</label>
      <select id="inputLang">
        <option value="en-US">ì˜ì–´ (en-US)</option>
        <option value="ko-KR">í•œêµ­ì–´ (ko-KR)</option>
        <option value="ja-JP">ì¼ë³¸ì–´ (ja-JP)</option>
        <option value="zh-CN">ì¤‘êµ­ì–´ (zh-CN)</option>
      </select>
    </div>
    <div class="row">
      <label for="outputLang">ì¶œë ¥ ì–¸ì–´</label>
      <select id="outputLang">
        <option value="KO">í•œêµ­ì–´</option>
        <option value="EN">ì˜ì–´</option>
        <option value="JA">ì¼ë³¸ì–´</option>
        <option value="ZH">ì¤‘êµ­ì–´</option>
      </select>
    </div>
    <div class="row">
      <button id="startBtn">ğŸ™ï¸ ì¸ì‹ ì‹œì‘</button>
      <button id="stopBtn" class="secondary" disabled>â¹ï¸ ì •ì§€</button>
      <span class="status" id="statusText">ëŒ€ê¸° ì¤‘</span>
    </div>
  </div>

  <div class="panel">
    <h2>ì „ë¬¸ ìš©ì–´ ì‚¬ì „ (Glossary)</h2>
    <div class="row" style="align-items:flex-start">
      <label for="glossaryInput" style="margin-top:6px">ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„</label>
      <textarea id="glossaryInput" placeholder="ì˜ˆ) Generative AI, LLM, ì»¨í¼ëŸ°ìŠ¤ëª…, ìŠ¤í”¼ì»¤ ì´ë¦„"></textarea>
    </div>
    <small>ì…ë ¥í•œ ìš©ì–´ëŠ” ë²ˆì—­ ì»¨í…ìŠ¤íŠ¸ì— ë°˜ì˜ë˜ê³ , ë²ˆì—­ ê²°ê³¼ë„ ì´ ìš©ì–´ë¡œ ê°•ì œ ë³´ì •ë©ë‹ˆë‹¤.</small>
  </div>

  <div class="panel">
    <h2>ë””ìì¸ ì„¤ì •</h2>
    <div class="row">
      <label for="origSize">ì›ë¬¸ ê¸€ì í¬ê¸°</label>
      <input type="range" id="origSize" min="20" max="120" value="64">
      <span id="origSizeVal">64px</span>
    </div>
    <div class="row">
      <label for="origColor">ì›ë¬¸ ê¸€ì ìƒ‰</label>
      <input type="color" id="origColor" value="#ffffff">
    </div>
    <div class="row">
      <label for="origFont">ì›ë¬¸ í°íŠ¸</label>
      <select id="origFont">
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Noto Sans KR', sans-serif">Noto Sans KR</option>
        <option value="'Roboto', sans-serif">Roboto</option>
        <option value="'Pretendard', sans-serif">Pretendard</option>
        <option value="'Nanum Gothic', sans-serif">Nanum Gothic</option>
        <option value="'Inter', sans-serif">Inter</option>
      </select>
    </div>
    <hr>
    <div class="row">
      <label for="transSize">ë²ˆì—­ ê¸€ì í¬ê¸°</label>
      <input type="range" id="transSize" min="20" max="120" value="68">
      <span id="transSizeVal">68px</span>
    </div>
    <div class="row">
      <label for="transColor">ë²ˆì—­ ê¸€ì ìƒ‰</label>
      <input type="color" id="transColor" value="#ffd166">
    </div>
    <div class="row">
      <label for="transFont">ë²ˆì—­ í°íŠ¸</label>
      <select id="transFont">
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Noto Sans KR', sans-serif">Noto Sans KR</option>
        <option value="'Roboto', sans-serif">Roboto</option>
        <option value="'Pretendard', sans-serif">Pretendard</option>
        <option value="'Nanum Gothic', sans-serif">Nanum Gothic</option>
        <option value="'Inter', sans-serif">Inter</option>
      </select>
    </div>
    <hr>
    <div class="row">
      <label for="paddingControl">ìƒí•˜ ì—¬ë°±</label>
      <input type="range" id="paddingControl" min="0" max="120" value="24">
      <span id="paddingVal">24px</span>
    </div>
  </div>

  <div class="panel">
    <h2>ë¡œê³  ì—…ë¡œë“œ</h2>
    <div class="row">
      <input type="file" id="logoInput" accept="image/*">
      <small>ìš°ì¸¡ ìƒë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.</small>
    </div>
    <div class="preview">
      <img id="logoPreview" class="logo-preview" alt="ë¡œê³  ë¯¸ë¦¬ë³´ê¸°">
    </div>
  </div>

  <div class="panel">
    <h2>ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</h2>
    <div class="preview" id="originalPreview">ì›ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    <div class="preview" id="translatedPreview">ë²ˆì—­ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
  </div>

  <script>
    const LS_CONFIG_KEY = "subtitle-config";
    const LS_PAYLOAD_KEY = "subtitle-payload";
    const DEBOUNCE_MS = 500;
    const statusText = document.getElementById("statusText");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const originalPreview = document.getElementById("originalPreview");
    const translatedPreview = document.getElementById("translatedPreview");
    const logoPreview = document.getElementById("logoPreview");
    const fields = {
      inputLang: document.getElementById("inputLang"),
      outputLang: document.getElementById("outputLang"),
      glossaryInput: document.getElementById("glossaryInput"),
      origSize: document.getElementById("origSize"),
      origColor: document.getElementById("origColor"),
      origFont: document.getElementById("origFont"),
      transSize: document.getElementById("transSize"),
      transColor: document.getElementById("transColor"),
      transFont: document.getElementById("transFont"),
      paddingControl: document.getElementById("paddingControl"),
      logoInput: document.getElementById("logoInput"),
      origSizeVal: document.getElementById("origSizeVal"),
      transSizeVal: document.getElementById("transSizeVal"),
      paddingVal: document.getElementById("paddingVal"),
    };

    let recognition = null;
    let debounceTimer = null;
    let isRecognizing = false;

    function loadConfig() {
      try {
        const raw = localStorage.getItem(LS_CONFIG_KEY);
        if (!raw) return;
        const cfg = JSON.parse(raw);
        Object.entries(cfg).forEach(([key, value]) => {
          if (fields[key]) {
            fields[key].value = value;
            if (key === "origSize") fields.origSizeVal.textContent = value + "px";
            if (key === "transSize") fields.transSizeVal.textContent = value + "px";
            if (key === "paddingControl") fields.paddingVal.textContent = value + "px";
          }
        });
        if (cfg.logoDataUrl) {
          logoPreview.src = cfg.logoDataUrl;
        }
      } catch (e) {
        console.error("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜", e);
      }
    }

    function saveConfig(extra = {}) {
      const config = {
        inputLang: fields.inputLang.value,
        outputLang: fields.outputLang.value,
        glossaryInput: fields.glossaryInput.value || "",
        origSize: fields.origSize.value,
        origColor: fields.origColor.value,
        origFont: fields.origFont.value,
        transSize: fields.transSize.value,
        transColor: fields.transColor.value,
        transFont: fields.transFont.value,
        paddingControl: fields.paddingControl.value,
        logoDataUrl: logoPreview.src || "",
        ...extra,
      };
      localStorage.setItem(LS_CONFIG_KEY, JSON.stringify(config));
    }

    function updatePayload(original, translated, isFinal = false) {
      const payload = {
        original: original ?? originalPreview.textContent,
        translated: translated ?? translatedPreview.textContent,
        isFinal,
        timestamp: Date.now(),
      };
      localStorage.setItem(LS_PAYLOAD_KEY, JSON.stringify(payload));
      if (original !== undefined) originalPreview.textContent = original;
      if (translated !== undefined) translatedPreview.textContent = translated;
    }

    function debounceTranslate(text) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => translateAndUpdate(text), DEBOUNCE_MS);
    }

    async function translateAndUpdate(text) {
      if (!text) return;
      try {
        const resText = await translateText(text, fields.outputLang.value);
        const postProcessed = applyGlossary(resText);
        updatePayload(undefined, postProcessed);
      } catch (e) {
        console.error("ë²ˆì—­ ì‹¤íŒ¨", e);
        statusText.textContent = "ë²ˆì—­ ì˜¤ë¥˜: " + e.message;
      }
    }

    function getGlossaryTerms() {
      return (fields.glossaryInput.value || "")
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
    }

    function buildContextPrompt() {
      const terms = getGlossaryTerms();
      if (!terms.length) return "";
      return `ë„ˆëŠ” ì „ë¬¸ ì»¨í¼ëŸ°ìŠ¤ í†µì—­ì‚¬ì•¼. ì•„ë˜ì˜ ì „ë¬¸ ìš©ì–´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•´ì„œ, ì¸ì‹ëœ ìŒì„±ì„ ë¬¸ë§¥ì— ë§ê²Œ ë²ˆì—­í•´ì¤˜. [${terms.join(", ")}]`;
    }

    function applyGlossary(translatedText) {
      if (!translatedText) return translatedText;
      const terms = getGlossaryTerms();
      if (!terms.length) return translatedText;
      let output = translatedText;
      terms.forEach(term => {
        if (!term) return;
        const safe = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const regex = new RegExp(safe, "gi");
        output = output.replace(regex, term);
      });
      return output;
    }

    async function translateText(text, targetLang) {
      // ê¸°ë³¸ ë¬´ë£Œ API: MyMemory
      const context = buildContextPrompt();
      const combined = context ? `${text}\nContext:${context}` : text;
      const encoded = encodeURIComponent(combined);
      const langPair = encodeURIComponent(fields.inputLang.value.split("-")[0] + "|" + targetLang.toLowerCase());
      const url = `https://api.mymemory.translated.net/get?q=${encoded}&langpair=${langPair}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data?.responseData?.translatedText) {
        return data.responseData.translatedText;
      }
      throw new Error("ë²ˆì—­ ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    }

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
        return null;
      }
      const rec = new SpeechRecognition();
      rec.continuous = true;
      rec.interimResults = true;
      rec.lang = fields.inputLang.value;
      rec.onstart = () => {
        isRecognizing = true;
        statusText.textContent = "ë“£ëŠ” ì¤‘...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };
      rec.onerror = (e) => {
        console.error("ì¸ì‹ ì˜¤ë¥˜", e);
        statusText.textContent = "ì˜¤ë¥˜: " + (e.error || "unknown");
      };
      rec.onend = () => {
        isRecognizing = false;
        statusText.textContent = "ì¤‘ì§€ë¨";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
      rec.onresult = (event) => {
        let interim = "";
        let finalTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interim += transcript;
          }
        }
        const combined = (finalTranscript || "") + (interim ? " " + interim : "");
        updatePayload(combined, undefined, !!finalTranscript);
        debounceTranslate(combined);
      };
      return rec;
    }

    function startRecognition() {
      if (isRecognizing) return;
      if (!recognition) recognition = initRecognition();
      if (recognition) {
        recognition.lang = fields.inputLang.value;
        recognition.start();
      }
    }

    function stopRecognition() {
      if (recognition && isRecognizing) {
        recognition.stop();
      }
    }

    function bindControls() {
      [
        "inputLang","outputLang","origColor","origFont",
        "transColor","transFont","glossaryInput"
      ].forEach(id => {
        fields[id].addEventListener("change", () => {
          saveConfig();
          updatePayload(); // ìŠ¤íƒ€ì¼ë§Œ ë°”ë€Œì–´ë„ displayê°€ storage ì´ë²¤íŠ¸ë¡œ ë°˜ì‘
        });
      });

      [["origSize","origSizeVal"], ["transSize","transSizeVal"], ["paddingControl","paddingVal"]]
        .forEach(([rangeId, labelId]) => {
          fields[rangeId].addEventListener("input", () => {
            fields[labelId].textContent = fields[rangeId].value + "px";
            saveConfig();
            updatePayload();
          });
        });

      fields.logoInput.addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          logoPreview.src = reader.result;
          saveConfig();
          updatePayload();
        };
        reader.readAsDataURL(file);
      });

      startBtn.addEventListener("click", startRecognition);
      stopBtn.addEventListener("click", stopRecognition);
    }

    function init() {
      loadConfig();
      bindControls();
      saveConfig();
      updatePayload("ì›ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...", "ë²ˆì—­ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...", false);
    }

    init();
  </script>
</body>
</html>
